name: Build Morphe Apps

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # =================================================
      # Repository checkout
      # =================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =================================================
      # Java setup (required by Morphe CLI & tools)
      # =================================================
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # =================================================
      # Restore signing keystore from GitHub Secrets
      # =================================================
      - name: Restore signing keystore from GitHub Secrets
        run: |
          echo "${{ secrets.MORPHE_KEYSTORE_B64 }}" | base64 -d > morphe-release.bks
          ls -lh morphe-release.bks

      # =================================================
      # Resolve latest stable Morphe components
      # =================================================
      - name: Resolve Morphe versions (stable only)
        run: |
          PATCH_VERSION=$(curl -s https://api.github.com/repos/MorpheApp/morphe-patches/releases \
            | jq -r '[.[] | select(.prerelease == false)][0].tag_name' | sed 's/^v//')

          CLI_VERSION=$(curl -s https://api.github.com/repos/MorpheApp/morphe-cli/releases \
            | jq -r '[.[] | select(.prerelease == false)][0].tag_name' | sed 's/^v//')

          APKEDITOR_URL=$(curl -s https://api.github.com/repos/REAndroid/APKEditor/releases \
            | jq -r '[.[] | select(.prerelease == false)][0].assets[]
                     | select(.name | endswith(".jar"))
                     | .browser_download_url')

          echo "PATCH_VERSION=$PATCH_VERSION" >> $GITHUB_ENV
          echo "CLI_VERSION=$CLI_VERSION" >> $GITHUB_ENV
          echo "APKEDITOR_URL=$APKEDITOR_URL" >> $GITHUB_ENV

      # =================================================
      # Resolve supported app versions from Morphe patches
      # =================================================
      - name: Resolve supported app versions from Morphe patches
        run: |
          set -e

          PATCH_JSON=$(curl -s https://raw.githubusercontent.com/MorpheApp/morphe-patches/main/patches-list.json)

          SUPPORTED_YT=$(echo "$PATCH_JSON" | jq -r '
            .patches[]
            | .compatiblePackages["com.google.android.youtube"]? // empty
            | .[]
          ' | sort -u)

          SUPPORTED_MUSIC=$(echo "$PATCH_JSON" | jq -r '
            .patches[]
            | .compatiblePackages["com.google.android.apps.youtube.music"]? // empty
            | .[]
          ' | sort -u)

          SUPPORTED_REDDIT=$(echo "$PATCH_JSON" | jq -r '
            .patches[]
            | .compatiblePackages["com.reddit.frontpage"]? // empty
            | .[]
          ' | sort -u)

          INDEX_JSON=$(curl -s https://api.github.com/repos/rjaakash/ci-artifact-index/releases?per_page=100)

          AVAILABLE_YT=$(echo "$INDEX_JSON" | jq -r '
            .[]
            | select(.tag_name | startswith("YouTube-"))
            | .tag_name
            | sub("^YouTube-"; "")
          ' | sort -u)

          AVAILABLE_MUSIC=$(echo "$INDEX_JSON" | jq -r '
            .[]
            | select(.tag_name | startswith("Music-"))
            | .tag_name
            | sub("^Music-"; "")
          ' | sort -u)

          AVAILABLE_REDDIT=$(echo "$INDEX_JSON" | jq -r '
            .[]
            | select(.tag_name | startswith("Reddit-"))
            | .tag_name
            | sub("^Reddit-"; "")
          ' | sort -u)

          YT_VERSION=$(comm -12 \
            <(echo "$SUPPORTED_YT" | sort -V) \
            <(echo "$AVAILABLE_YT" | sort -V) \
          | sort -V | tail -n 1)

          MUSIC_VERSION=$(comm -12 \
            <(echo "$SUPPORTED_MUSIC" | sort -V) \
            <(echo "$AVAILABLE_MUSIC" | sort -V) \
          | sort -V | tail -n 1)

          REDDIT_VERSION=$(comm -12 \
            <(echo "$SUPPORTED_REDDIT" | sort -V) \
            <(echo "$AVAILABLE_REDDIT" | sort -V) \
          | sort -V | tail -n 1)

          # Only YouTube and Music are mandatory
          if [ -z "$YT_VERSION" ] || [ -z "$MUSIC_VERSION" ]; then
            echo "No compatible version found for YouTube or Music"
            exit 1
          fi

          echo "YOUTUBE_VERSION=$YT_VERSION" >> $GITHUB_ENV
          echo "MUSIC_VERSION=$MUSIC_VERSION" >> $GITHUB_ENV

          if [ -n "$REDDIT_VERSION" ]; then
            echo "REDDIT_VERSION=$REDDIT_VERSION" >> $GITHUB_ENV
            echo "REDDIT_APKM_URL=https://github.com/rjaakash/ci-artifact-index/releases/download/Reddit-${REDDIT_VERSION}/Reddit-${REDDIT_VERSION}.apkm" >> $GITHUB_ENV
          fi

          echo "YOUTUBE_APK_URL=https://github.com/rjaakash/ci-artifact-index/releases/download/YouTube-${YT_VERSION}/YouTube-${YT_VERSION}.apk" >> $GITHUB_ENV
          echo "MUSIC_APK_URL=https://github.com/rjaakash/ci-artifact-index/releases/download/Music-${MUSIC_VERSION}/Music-${MUSIC_VERSION}.apk" >> $GITHUB_ENV

      # =================================================
      # Run main build script (UPDATED PATH ONLY)
      # =================================================
      - name: Run build script
        env:
          KEYSTORE_PASSWORD: ${{ secrets.MORPHE_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.MORPHE_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.MORPHE_KEY_PASSWORD }}
        run: |
          chmod +x scripts/morphe.sh
          ./scripts/morphe.sh

      # =================================================
      # OPTIONAL: Fetch latest stable MicroG-RE APKs
      # =================================================
      - name: Fetch MicroG-RE APKs (stable, optional)
        run: |
          set +e
          echo "[+] Checking latest MicroG-RE stable release"

          RELEASE_JSON=$(curl -s https://api.github.com/repos/MorpheApp/MicroG-RE/releases)

          MICROG_TAG=$(echo "$RELEASE_JSON" | jq -r '[.[] | select(.prerelease == false)][0].tag_name')
          APK_URLS=$(echo "$RELEASE_JSON" | jq -r '
            [.[] | select(.prerelease == false)][0].assets[]
            | select(.name | endswith(".apk"))
            | .browser_download_url
          ')

          if [[ -z "$APK_URLS" ]]; then
            echo "No MicroG-RE APKs found, skipping"
            exit 0
          fi

          mkdir -p build/microg

          for url in $APK_URLS; do
            file=$(basename "$url")
            echo "Downloading $file"
            curl -L --fail "$url" -o "build/microg/$file"
          done

          echo "MICROG_VERSION=${MICROG_TAG#v}" >> $GITHUB_ENV

      # =================================================
      # Generate GitHub release notes dynamically
      # =================================================
      - name: Generate release notes
        run: |
          PATCH_TAG="v${PATCH_VERSION}"

          CHANGELOG=$(curl -s \
            https://api.github.com/repos/MorpheApp/morphe-patches/releases/tags/${PATCH_TAG} \
            | jq -r '.body')

          {
            echo "## Versions"
            echo
            echo "- YouTube: ${YOUTUBE_VERSION}"
            echo "- Music: ${MUSIC_VERSION}"

            if [ -f build/Reddit-Morphe.apk ]; then
              echo "- Reddit: ${REDDIT_VERSION}"
            fi

            if ls build/microg/*.apk >/dev/null 2>&1; then
              echo "- MicroG RE: ${MICROG_VERSION}"
            fi

            echo "- Morphe Patch: ${PATCH_VERSION}"
            echo "- Morphe CLI: ${CLI_VERSION}"
            echo
            echo "## Morphe Patch Changelog (${PATCH_TAG})"
            echo
            echo "${CHANGELOG}"
          } > release.md

          echo "RELEASE_TAG=Morphe-v${PATCH_VERSION}" >> $GITHUB_ENV
          echo "RELEASE_NAME=Morphe v${PATCH_VERSION}" >> $GITHUB_ENV

      # =================================================
      # Rename APK outputs to versioned filenames
      # =================================================
      - name: Rename APK assets
        run: |
          mv build/YouTube-Morphe.apk build/YouTube-v${YOUTUBE_VERSION}-v${PATCH_VERSION}.apk
          mv build/Music-Morphe.apk build/Music-v${MUSIC_VERSION}-v${PATCH_VERSION}.apk

          if [ -f build/Reddit-Morphe.apk ]; then
            mv build/Reddit-Morphe.apk build/Reddit-v${REDDIT_VERSION}-v${PATCH_VERSION}.apk
          fi

      # =================================================
      # Create GitHub release and upload all assets
      # =================================================
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body_path: release.md
          fail_on_unmatched_files: false
          files: |
            build/YouTube-v${{ env.YOUTUBE_VERSION }}-v${{ env.PATCH_VERSION }}.apk
            build/Music-v${{ env.MUSIC_VERSION }}-v${{ env.PATCH_VERSION }}.apk
            build/Reddit-v${{ env.REDDIT_VERSION }}-v${{ env.PATCH_VERSION }}.apk
            build/microg/*.apk

      # =================================================
      # Update version tracking files after successful release
      # =================================================
      - name: Update version tracking files after successful release
        if: success()
        run: |
          echo "$PATCH_VERSION" > versions/morphe.txt
          echo "$CLI_VERSION" > versions/cli.txt

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add versions/morphe.txt versions/cli.txt

          if git diff --cached --quiet; then
            exit 0
          fi

          MSG="chore: update Morphe patch to ${PATCH_VERSION}"

          if git diff --cached versions/cli.txt | grep -q .; then
            MSG="$MSG, CLI to ${CLI_VERSION}"
          fi

          git commit -m "$MSG"
          git push
