name: Build Morphe Apps

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # =================================================
      # Repository checkout
      # =================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =================================================
      # Java setup (required by Morphe CLI & tools)
      # =================================================
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # =================================================
      # Restore signing keystore from GitHub Secrets
      # =================================================
      - name: Restore keystore from GitHub Secrets
        run: |
          echo "${{ secrets.MORPHE_KEYSTORE_B64 }}" | base64 -d > morphe-release.bks
          ls -lh morphe-release.bks

      # =================================================
      # Resolve latest stable Morphe components
      # =================================================
      - name: Resolve Morphe versions (stable only)
        run: |
          PATCH_VERSION=$(curl -s https://api.github.com/repos/MorpheApp/morphe-patches/releases \
            | jq -r '[.[] | select(.prerelease == false)][0].tag_name' | sed 's/^v//')

          CLI_VERSION=$(curl -s https://api.github.com/repos/MorpheApp/morphe-cli/releases \
            | jq -r '[.[] | select(.prerelease == false)][0].tag_name' | sed 's/^v//')

          APKEDITOR_URL=$(curl -s https://api.github.com/repos/REAndroid/APKEditor/releases \
            | jq -r '[.[] | select(.prerelease == false)][0].assets[]
                     | select(.name | endswith(".jar"))
                     | .browser_download_url')

          echo "PATCH_VERSION=$PATCH_VERSION" >> $GITHUB_ENV
          echo "CLI_VERSION=$CLI_VERSION" >> $GITHUB_ENV
          echo "APKEDITOR_URL=$APKEDITOR_URL" >> $GITHUB_ENV

      # =================================================
      # Resolve app versions + URLs from ci-artifact-index
      # =================================================
      - name: Resolve app artifacts from index repo
        run: |
          API="https://api.github.com/repos/rjaakash/ci-artifact-index/releases"

          get_latest () {
            local name="$1"
            curl -s "$API" \
              | jq -r ".[] | select(.tag_name | startswith(\"$name-\")) | .tag_name" \
              | sort -V | tail -n 1
          }

          YT_TAG=$(get_latest YouTube)
          MUSIC_TAG=$(get_latest Music)
          REDDIT_TAG=$(get_latest Reddit)

          YOUTUBE_VERSION="${YT_TAG#YouTube-}"
          MUSIC_VERSION="${MUSIC_TAG#Music-}"
          REDDIT_VERSION="${REDDIT_TAG#Reddit-}"

          echo "YOUTUBE_VERSION=$YOUTUBE_VERSION" >> $GITHUB_ENV
          echo "MUSIC_VERSION=$MUSIC_VERSION" >> $GITHUB_ENV
          echo "REDDIT_VERSION=$REDDIT_VERSION" >> $GITHUB_ENV

          echo "YOUTUBE_APK_URL=https://github.com/rjaakash/ci-artifact-index/releases/download/${YT_TAG}/YouTube-${YOUTUBE_VERSION}.apk" >> $GITHUB_ENV
          echo "MUSIC_APK_URL=https://github.com/rjaakash/ci-artifact-index/releases/download/${MUSIC_TAG}/Music-${MUSIC_VERSION}.apk" >> $GITHUB_ENV
          echo "REDDIT_APKM_URL=https://github.com/rjaakash/ci-artifact-index/releases/download/${REDDIT_TAG}/Reddit-${REDDIT_VERSION}.apkm" >> $GITHUB_ENV

      # =================================================
      # Run main build script
      # =================================================
      - name: Run build script
        env:
          KEYSTORE_PASSWORD: ${{ secrets.MORPHE_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.MORPHE_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.MORPHE_KEY_PASSWORD }}
        run: |
          chmod +x build.sh
          ./build.sh

      # =================================================
      # OPTIONAL: Fetch latest stable MicroG-RE APKs
      # =================================================
      - name: Fetch MicroG-RE APKs (stable, optional)
        run: |
          set +e
          echo "[+] Checking latest MicroG-RE stable release"

          RELEASE_JSON=$(curl -s https://api.github.com/repos/MorpheApp/MicroG-RE/releases)

          MICROG_TAG=$(echo "$RELEASE_JSON" | jq -r '[.[] | select(.prerelease == false)][0].tag_name')
          APK_URLS=$(echo "$RELEASE_JSON" | jq -r '
            [.[] | select(.prerelease == false)][0].assets[]
            | select(.name | endswith(".apk"))
            | .browser_download_url
          ')

          if [[ -z "$APK_URLS" ]]; then
            echo "No MicroG-RE APKs found, skipping"
            exit 0
          fi

          mkdir -p build/microg

          for url in $APK_URLS; do
            file=$(basename "$url")
            echo "Downloading $file"
            curl -L --fail "$url" -o "build/microg/$file"
          done

          echo "MICROG_VERSION=${MICROG_TAG#v}" >> $GITHUB_ENV

      # =================================================
      # Generate GitHub release notes dynamically
      # =================================================
      - name: Generate release notes
        run: |
          DATE_TAG=$(date +'%Y-%m-%d')
          PATCH_TAG="v${PATCH_VERSION}"

          CHANGELOG=$(curl -s \
            https://api.github.com/repos/MorpheApp/morphe-patches/releases/tags/${PATCH_TAG} \
            | jq -r '.body')

          {
            echo "## Versions"
            echo
            echo "- YouTube: ${YOUTUBE_VERSION}"
            echo "- Music: ${MUSIC_VERSION}"

            if [ -f build/Reddit-Morphe.apk ]; then
              echo "- Reddit: ${REDDIT_VERSION}"
            fi

            if ls build/microg/*.apk >/dev/null 2>&1; then
              echo "- MicroG: ${MICROG_VERSION}"
            fi

            echo "- Morphe Patch: ${PATCH_VERSION}"
            echo "- Morphe CLI: ${CLI_VERSION}"
            echo
            echo "## Morphe Patch Changelog (${PATCH_TAG})"
            echo
            echo "${CHANGELOG}"
          } > release.md

          echo "RELEASE_TAG=v${PATCH_VERSION}" >> $GITHUB_ENV
          echo "RELEASE_NAME=${DATE_TAG}" >> $GITHUB_ENV

      # =================================================
      # Rename APK outputs to versioned filenames
      # =================================================
      - name: Rename APK assets
        run: |
          mv build/YouTube-Morphe.apk build/YouTube-v${YOUTUBE_VERSION}-v${PATCH_VERSION}.apk
          mv build/Music-Morphe.apk build/Music-v${MUSIC_VERSION}-v${PATCH_VERSION}.apk

          if [ -f build/Reddit-Morphe.apk ]; then
            mv build/Reddit-Morphe.apk build/Reddit-v${REDDIT_VERSION}-v${PATCH_VERSION}.apk
          fi

      # =================================================
      # Create GitHub release and upload all assets
      # =================================================
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body_path: release.md
          fail_on_unmatched_files: false
          files: |
            build/YouTube-v${{ env.YOUTUBE_VERSION }}-v${{ env.PATCH_VERSION }}.apk
            build/Music-v${{ env.MUSIC_VERSION }}-v${{ env.PATCH_VERSION }}.apk
            build/Reddit-v${{ env.REDDIT_VERSION }}-v${{ env.PATCH_VERSION }}.apk
            build/microg/*.apk

      # =================================================
      # Update version tracking files after successful release
      # =================================================
      - name: Update version files after successful release
        if: success()
        run: |
          echo "$PATCH_VERSION" > morphe-patches-version.txt
          echo "$CLI_VERSION" > morphe-cli-version.txt

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add morphe-patches-version.txt morphe-cli-version.txt

          if git diff --cached --quiet; then
            exit 0
          fi

          MSG="chore: update Morphe patch to ${PATCH_VERSION}"

          if git diff --cached morphe-cli-version.txt | grep -q .; then
            MSG="$MSG, CLI to ${CLI_VERSION}"
          fi

          git commit -m "$MSG"
          git push
